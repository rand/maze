direction: right

title: MAZE 5-Stage Pipeline {
  near: top-center
  shape: text
  style: {
    font-size: 28
    bold: true
  }
}

context_indexer: {
  label: "Stage 1: Context Indexer"
  shape: rectangle
  style: {
    fill: "#1E3A8A"
    stroke: "#1E3A8A"
    font-color: white
  }

  input: "ðŸ“ Source Files" {
    shape: text
    style.font-size: 14
  }

  process: "Extract symbols, types,\npatterns, conventions" {
    shape: text
    style.font-size: 12
  }

  output: "ðŸ“Š Type Context" {
    shape: text
    style.font-size: 14
    style.bold: true
  }

  status: "TypeScript âœ…" {
    shape: text
    style.font-size: 11
    style.italic: true
  }
}

constraint_synthesis: {
  label: "Stage 2: Constraint Synthesis"
  shape: rectangle
  style: {
    fill: "#059669"
    stroke: "#059669"
    font-color: white
  }

  grammar: "GrammarBuilder\n(CFG/Lark) âœ…" {
    shape: text
    style.font-size: 12
  }

  converter: "TypeToGrammar\nConverter âœ…" {
    shape: text
    style.font-size: 12
  }

  schema: "SchemaBuilder\n(JSON Schema) âœ…" {
    shape: text
    style.font-size: 12
  }

  output: "ðŸ“ Constraint Set\n(4 tiers)" {
    shape: text
    style.font-size: 14
    style.bold: true
  }
}

decode_orchestrator: {
  label: "Stage 3: Decode Orchestrator"
  shape: rectangle
  style: {
    fill: "#D97706"
    stroke: "#D97706"
    font-color: white
  }

  llguidance: "llguidance\nintegration âœ…" {
    shape: text
    style.font-size: 12
  }

  providers: "Multi-provider\n(OpenAI, vLLM,\nSGLang, llama.cpp)" {
    shape: text
    style.font-size: 11
  }

  enforcement: "Real-time\nconstraint\nenforcement" {
    shape: text
    style.font-size: 12
  }

  output: "ðŸ’» Generated Code" {
    shape: text
    style.font-size: 14
    style.bold: true
  }
}

validation: {
  label: "Stage 4: Post-Validation"
  shape: rectangle
  style: {
    fill: "#7C3AED"
    stroke: "#7C3AED"
    font-color: white
  }

  parallel: "âš¡ Parallel Streams:" {
    shape: text
    style.font-size: 13
    style.bold: true
  }

  syntax: "â€¢ SyntaxValidator âœ…" {
    shape: text
    style.font-size: 12
  }

  types: "â€¢ TypeValidator âœ…" {
    shape: text
    style.font-size: 12
  }

  tests: "â€¢ TestValidator âœ…" {
    shape: text
    style.font-size: 12
  }

  lint: "â€¢ LintValidator âœ…" {
    shape: text
    style.font-size: 12
  }

  output: "ðŸ“‹ Diagnostics" {
    shape: text
    style.font-size: 14
    style.bold: true
  }
}

repair: {
  label: "Stage 5: Repair Loop"
  shape: rectangle
  style: {
    fill: "#475569"
    stroke: "#475569"
    font-color: white
  }

  analyze: "Analyze\ndiagnostics ðŸ“‹" {
    shape: text
    style.font-size: 12
  }

  refine: "Refine\nconstraints ðŸ“‹" {
    shape: text
    style.font-size: 12
  }

  regenerate: "Regenerate ðŸ“‹" {
    shape: text
    style.font-size: 12
  }

  limit: "Max 3 attempts" {
    shape: text
    style.font-size: 11
    style.italic: true
  }
}

# Flow arrows
context_indexer -> constraint_synthesis: {
  label: "Type Context"
  style: {
    stroke-width: 3
    font-size: 11
  }
}

constraint_synthesis -> decode_orchestrator: {
  label: "Constraint Set"
  style: {
    stroke-width: 3
    font-size: 11
  }
}

decode_orchestrator -> validation: {
  label: "Generated Code"
  style: {
    stroke-width: 3
    font-size: 11
  }
}

validation -> repair: {
  label: "Diagnostics\n(if validation fails)"
  style: {
    stroke-width: 3
    font-size: 10
    stroke-dash: 4
  }
}

repair -> constraint_synthesis: {
  label: "Refined Constraints"
  style: {
    stroke-width: 2
    font-size: 10
    stroke-dash: 4
  }
}
